<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{{ .TabTitle }}</title>
    <meta name="theme-color" content="#111113">
    <link rel="apple-touch-icon" href="{{ .BaseURL }}/static/images/icon-192.png">
    <link rel="manifest" href="{{ .BaseURL }}/manifest.json">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; font-src 'self'; object-src 'none'; base-uri 'self'; worker-src 'self'; manifest-src 'self';">
    
    {{ if .Assets }}
    <link rel="stylesheet" href="{{ .BaseURL }}{{ index .Assets "/static/css/layout.css" }}">
    <link rel="stylesheet" href="{{ .BaseURL }}{{ index .Assets "/static/css/theme.css" }}">
    <link rel="stylesheet" href="{{ .BaseURL }}{{ index .Assets "/static/css/graph.css" }}">
    <script src="{{ .BaseURL }}{{ index .Assets "/static/js/force-graph.js" }}"></script>
    {{ else }}
    <link rel="stylesheet" href="{{ .BaseURL }}/static/css/graph.css">
    <script src="{{ .BaseURL }}/static/js/force-graph.js"></script>
    {{ end }}
    {{ if .Config.Logo }}
    <link rel="icon" type="image/png" href="{{ .BaseURL }}/{{ .Config.Logo }}">
    {{ else }}
    <link rel="icon" href="{{ .BaseURL }}/static/images/favicon.png" width="35" height="35">
    {{ end }}
</head>

<body>

<div id="loading" class="loading"></div>

<div id="controls">
    <div class="control-panel">
        <div class="panel-header">
            <span class="graph-icon">üï∏Ô∏è</span>
            <h1>Knowledge Graph</h1>
        </div>
        <a href="{{ .BaseURL }}/" class="btn-home">
            <span>‚Üê</span>
            <span>Home</span>
        </a>
    </div>
</div>

<div class="stats-panel" id="stats" style="display: none;">
    <div class="stat-item">
        <span class="stat-label">Posts</span>
        <span class="stat-value" id="postCount">0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Tags</span>
        <span class="stat-value" id="tagCount">0</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">Links</span>
        <span class="stat-value" id="linkCount">0</span>
    </div>
</div>

<div id="graph-container"></div>

<script>
    window.GRAPH_BASE_URL = '{{ .BaseURL }}';
</script>

{{ if .Assets }}
<script src="{{ .BaseURL }}{{ index .Assets "/static/js/graph.js" }}"></script>
{{ else }}
<script src="{{ .BaseURL }}/static/js/graph.js"></script>
{{ end }}

<script>
    (function() {
        const hosts = ["localhost", "127.0.0.1", "0.0.0.0"];
        
        // DEV MODE: Aggressive cache clearing and SW nuking
        if (hosts.includes(window.location.hostname)) {
            // Immediately unregister any Service Workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => {
                        registration.unregister();
                        console.log('üöß Service Worker unregistered');
                    });
                });
            }
            
            // Clear caches
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    cacheNames.forEach(cacheName => {
                        caches.delete(cacheName);
                        console.log('üóëÔ∏è Cache cleared:', cacheName);
                    });
                });
            }
        } else {
            // Production: PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swPath = '{{ .BaseURL }}/sw.js';
                    navigator.serviceWorker.register(swPath)
                        .then(registration => {
                            console.log('‚úÖ ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.error('‚ùå ServiceWorker registration failed: ', err);
                        });
                });
            }
        }
    })();
</script>

</body>

</html>